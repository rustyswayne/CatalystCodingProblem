var Peeps=function(){function e(){$(document).ready(function(){Peeps.Search.init(),Peeps.People.init(),Peeps.Dashboards.init()})}function n(){return!1}function i(e,n){try{var i=_.find(l,function(n){return n.event===e});if(void 0!==i&&null!==i)void 0!==n&&"function"==typeof n&&i.callbacks.push(n);else{var o=[];void 0!==n&&"function"==typeof n&&o.push(n),l.push({event:e,callbacks:o})}}catch(e){console.info(e)}}function o(e,n){var i=_.find(l,function(n){return n.event===e});void 0!==i&&null!==i&&_.each(i.callbacks,function(i){try{i(e,n)}catch(i){MUI.Logger.captureError(i,{extra:{eventName:e,args:n}})}})}function t(e){var n={};return function(i,o){return n[i]||(n[i]=$.Deferred(function(n){e(n,i)}).promise()),n[i].done(o)}}function a(e,n){var i=_.find(e,function(e){return e.alias===n});return void 0===i?"":i.name}function r(e){c.events&&_.each(e,function(e){MUI.on(e.name,function(n,i){console.log(e),console.log(void 0===i?"No args":i)})})}function s(e){c.console&&console.log(e)}function d(e){return $(e).length>0}var c={events:!1,console:!0},l=[];return{Settings:{},init:e,willWork:d,hasLogger:n,createCache:t,on:i,emit:o,getEventNameByAlias:a,debugConsoleEvents:r,debugConsole:s}}();Peeps.Settings={localCacheDuration:10,spinnerSvg:"/Media/Placeholders/balls.svg",enableApiDelays:!0,searchApiEndpoint:"/api/searchapi/getall/",newPerson:"/people/newperson/",apiRoutes:[{id:"countrymetrics",value:"/dashboard/countriessnapshot",title:"Querying Country Metrics...",notes:"Country filter queries not implemented.",delay:750},{id:"peopleprops",value:"/dashboard/peoplepropertystats",title:"Evaluating Profiles...",notes:"Property filter queries not implemented.",delay:1250},{id:"randomwatched",value:"/dashboard/randomwatched",title:"Selecting random...",notes:"Randomly selected from watched",delay:0}]},Peeps.Dialogs={confirmDelete:function(e,n){Peeps.Dialogs.confirm({title:"Delete this person?",message:"This person will be permanently deleted and cannot be recovered. Are you sure?",confirm:e,cancel:n})},confirm:function(e){var n=$('<div id="dialog-confirm" title="'+e.title+'"><p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>'+e.message+"</p></div>");$("#peeps").html(n),$("#dialog-confirm").dialog({resizable:!1,height:"auto",width:400,modal:!0,buttons:{Confirm:function(){void 0!==e.confirm&&e.confirm(),$(this).dialog("close")},Cancel:function(){void 0!==e.cancel&&e.cancel(),$(this).dialog("close")}}})},popForm:function(e){var n='<div id="dialog-form" title="Create new user">'+e.frm+"</div>";return $("#peeps").html(n),$("#dialog-form").dialog({autoOpen:!1,height:"auto",width:600,modal:!0})}},Peeps.Dashboards={init:function(){var e=$("div[data-dashboard]");e.length&&_.each(e,function(e){Peeps.Dashboards.binder.invoke(e)})},binder:{invoke:function(e){var n=$(e).data("dashboard"),i=Peeps.Dashboards.spinner.makeId();Peeps.Dashboards.spinner.appendSpinner(e,i);var o={dashboard:e,args:{},skip:!0};if("donothing"!==n){var t=_.find(Peeps.Settings.apiRoutes,function(e){if(e.id===n)return e});void 0!==t&&(o.args=t,o.skip=!1,Peeps.Dashboards.binder.query(o))}},query:function(e){if(void 0===e)throw new Error("Routing params have not been defined.");var n=e.dashboard;$(n).find(".chart-title").text(e.args.title);var i=void 0===e.args.delay?0:e.args.delay;Peeps.Settings.enableApiDelays||(i=0),i>0&&$(n).find(".chart-notes").text("FAKE DELAY of ("+e.args.delay+" ms) added for demo!"),$(n).find(""),$.ajax({url:e.args.value,dataType:"html"}).done(function(e){setTimeout(function(){$(n).parent().html(e),$(n).find(".chart-notes").text("Note:")},i)}).fail(function(){console.log("Failure not implemented.")})}},spinner:{activeIds:[],appendSpinner:function(e,n){Peeps.Dashboards.spinner.activeIds.push(n);var i=Peeps.Dashboards.spinner.build(n);$(e).find(".chart-stage").html(i)},build:function(e){return $('<div class="dashboard-spinner"><img src="'+Peeps.Settings.spinnerSvg+'" id="'+e+'" alt="Loading..." /></div>')},makeId:function(){for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<10;i++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}}},Peeps.People={init:function(){Peeps.People.bind.deletes(),Peeps.People.bind.newPerson()},bind:{deletes:function(){Peeps.willWork(".delete-person")&&_.each($(".delete-person"),function(e){$(e).bind("click",function(e){e.preventDefault();var n=$(this).attr("href");Peeps.Dialogs.confirmDelete(function(){window.location=n})})})},newPerson:function(){Peeps.willWork("#new-person")&&$("#new-person").bind("click",function(e){$.get(Peeps.Settings.newPerson).done(function(e){var n=Peeps.Dialogs.popForm({frm:e});n.dialog("open"),Peeps.Forms.rebind(n),$(n).find(".cancel").bind("click",function(e){n.dialog("close")}),$(n).find("#birthday-picker").birthdayPicker({minAge:16}),$(n).find("form").bind("submit",function(e){$(this).find("#Birthday").val($(this).find(".birthDay").val())})})})}}},Peeps.Forms={rebind:function(e){$.validator.unobtrusive.parse(e)}},Peeps.Search={peopleMap:{},names:[],current:{},init:function(){Peeps.willWork("#person-search")&&$.get(Peeps.Settings.searchApiEndpoint).done(function(e){_.each(e,function(e){Peeps.Search.peopleMap[e.name]=e,Peeps.Search.names.push(e.name)}),Peeps.Search.bind.searchBox($("#person-search"))})},bind:{searchBox:function(e){var n=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,local:Peeps.Search.names});$(e).bind("keydown",function(e){var n=new RegExp("^[a-zA-Z0-9]"),i=e.charCode?e.charCode:e.which,o=String.fromCharCode(i);if(!n.test(o)&&32!==i&&8!==i)return e.preventDefault(),!1}).typeahead({hint:!0,highlight:!0,minLength:1},{name:"names",source:n}).bind("typeahead:select",function(e,n){console.log("Selection: "+n),Peeps.Search.redirect(n)}).bind("typeahead:autocompleted",function(e,n){console.log("Auto: "+n),Peeps.Search.redirect(n)})}},redirect:function(e){var n=Peeps.Search.peopleMap[e];window.location=n.url}},Peeps.init();